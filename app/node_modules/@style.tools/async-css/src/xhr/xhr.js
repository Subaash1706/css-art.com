/**
 * Async CSS loader - github.com/style-tools/async-css
 * Released under the terms of MIT license
 *
 * Copyright (C) 2018 github.com/style-tools
 */
var _XDomainRequest = w.XDomainRequest;

// XHR request module
XHR = function(args, callback) {

    var href = args[0],
        xhr_config = args[1],
        cors = OBJECT(args[2], VAR_PROXY),
        use_cors_proxy = args[3],
        head_update = args[4],
        head_update_date,
        proxy = cors[VAR_PROXY],
        xhr,
        last_modified, fallback_to_proxy;

    if (!href || (use_cors_proxy && !cors)) {
        callback();
    } else {

        // proxify URL
        proxy = !use_cors_proxy ? href : (IS_INDEX_OF(proxy, 'µ') ? proxy.replace('µ', href) : proxy + href);

        // use CORS proxy as fallback
        fallback_to_proxy = function() {
            if (!use_cors_proxy) {
                args[3] = use_cors_proxy = 1;
                XHR(args, callback);
            }
        }

        // XHR for Chrome/Firefox/Opera/Safari.
        if (IS_UNDEFINED(_XDomainRequest)) {
            xhr = new XMLHttpRequest();
        } else {

            // XDomainRequest for IE.
            xhr = new _XDomainRequest();
        }
        xhr.open(head_update ? 'HEAD' : 'GET', proxy, true);

        // Setup our listener to process compeleted requests
        xhr.onreadystatechange = function() {

            // Only run if the request is complete
            if (xhr.readyState === 4) {
                var status = xhr.status;

                // read last modified header
                last_modified = xhr.getResponseHeader("Last-Modified");
                if (last_modified) {
                    last_modified = new Date(last_modified).getTime() / 1000;
                }

                if (head_update) {
                    if (last_modified && last_modified < head_update_date) {
                        status = 304;
                    }

                    if (status === 200) {

                        // GET
                        XHR([args[0], args[1]], callback);
                    } else if (status === 304) {
                        callback(status, last_modified, use_cors_proxy);
                    } else {

                        // try again with CORS proxy
                        fallback_to_proxy();
                    }
                } else if (status === 200) {
                    callback(xhr.responseText, last_modified, use_cors_proxy);
                } else if (status !== 200) {
                    fallback_to_proxy();
                }
            }
        };

        xhr.onerror = function(err) {
            if (DEBUG) {
                CONSOLE_ERROR('cors', head_update ? 'HEAD' : 'GET', proxy, err);
            }
            if (API) {
                ERROR('cors', [head_update ? 'HEAD' : 'GET', proxy, err]);
            }

            fallback_to_proxy();
        };

        if (head_update) {
            head_update_date = new Date(head_update * 1000);
            xhr.setRequestHeader("If-Modified-Since", head_update_date.toUTCString());
        }

        xhr.send();
    }

};