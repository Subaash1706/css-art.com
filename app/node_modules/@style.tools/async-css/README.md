[![Version](https://img.shields.io/github/release/style-tools/async-css.svg)](https://github.com/style-tools/async-css/releases) [![npm version](https://badge.fury.io/js/%40style.tools%2Fasync-css.svg)](http://badge.fury.io/js/%40style.tools%2Fasync-css)

# Async CSS Loader

A lightweight, IE8+ asynchronous CSS loader that favors performance in modern browsers.

### Install via npm

```bash
npm install @style.tools/async-css --save
```

The solution is similar to [loadCSS](https://github.com/filamentgroup/loadCSS) but enhanced with:

1. Timed and responsive download and/or render.
2. Dependency based CSS rendering.
3. [in-view](https://github.com/camwiegert/in-view) (element in view) based download and/or render.
4. `requestAnimationFrame` and `requestIdleCallback` (smooth rendering)
5. Chainable and events.
6. `localStorage` or [Cache API](https://developer.mozilla.org/en-US/docs/Web/API/Cache) based `<style>` loading (much faster)
7. Async injected stylesheet capture via `MutationObserver` or DOM insert method rewriting (rewrite, delete, responsive/conditional loading)
8. Fallback for browsers that do not support the loader via `try {} catch` and `<noscript rel="css">`.
9. An innovative script and config compression solution to achieve the smallest possible size in the HTML document header.
10. [Performance API](https://developer.mozilla.org/en-US/docs/Web/API/Performance) timings for debugging and optimization.

Despite the many features, the basic script size is `1.55kb` compressed. It is designed for `above-the-fold` optimization and to be included inline in the `<head>` section of a HTML document.

<details/>
  <summary>Show script sizes of CSS loader modules</summary>

```text
async-core.js Size: 1.95 kb (1999 bytes) Gzip: 0.96 kb (980 bytes).
css-loader.js Size: 1.02 kb (1043 bytes) Gzip: 0.61 kb (626 bytes).
js-loader.js Size: 1.60 kb (1637 bytes) Gzip: 0.89 kb (910 bytes).
attr-config.js Size: 0.25 kb (257 bytes) Gzip: 0.21 kb (216 bytes).
rebase.js Size: 0.18 kb (186 bytes) Gzip: 0.17 kb (169 bytes).
event-emitter.js Size: 0.46 kb (475 bytes) Gzip: 0.24 kb (246 bytes).
debug.js Size: 0.12 kb (120 bytes) Gzip: 0.12 kb (127 bytes).
regex.js Size: 0.14 kb (142 bytes) Gzip: 0.14 kb (140 bytes).
vendor.js Size: 0.18 kb (187 bytes) Gzip: 0.16 kb (165 bytes).
api.js Size: 0.27 kb (278 bytes) Gzip: 0.19 kb (198 bytes).
dependency.js Size: 0.68 kb (698 bytes) Gzip: 0.39 kb (396 bytes).
timing.js Size: 0.65 kb (668 bytes) Gzip: 0.38 kb (387 bytes).
inview.js Size: 0.89 kb (915 bytes) Gzip: 0.55 kb (561 bytes).
responsive.js Size: 0.26 kb (267 bytes) Gzip: 0.20 kb (201 bytes).
cache.js Size: 1.24 kb (1271 bytes) Gzip: 0.69 kb (709 bytes).
cache-css.js Size: 0.32 kb (323 bytes) Gzip: 0.24 kb (245 bytes).
cache-js.js Size: 0.11 kb (109 bytes) Gzip: 0.12 kb (119 bytes).
localstorage.js Size: 0.39 kb (399 bytes) Gzip: 0.26 kb (267 bytes).
cache-api.js Size: 0.62 kb (638 bytes) Gzip: 0.35 kb (359 bytes).
xhr.js Size: 0.68 kb (694 bytes) Gzip: 0.43 kb (444 bytes).
cache-update.js Size: 0.15 kb (152 bytes) Gzip: 0.13 kb (138 bytes).
capture.js Size: 1.14 kb (1166 bytes) Gzip: 0.66 kb (673 bytes).
capture-observer.js Size: 0.24 kb (249 bytes) Gzip: 0.19 kb (198 bytes).
capture-insert.js Size: 0.33 kb (333 bytes) Gzip: 0.22 kb (225 bytes).
capture-css.js Size: 0.14 kb (141 bytes) Gzip: 0.13 kb (130 bytes).
capture-js.js Size: 0.07 kb (69 bytes) Gzip: 0.08 kb (87 bytes).
```
</details>

### Performance first: no concessions for old browsers

The CSS loader favors performance in modern browsers. For example, `loadCSS` [waits for `document.body`](https://github.com/filamentgroup/loadCSS/blob/master/src/loadCSS.js#L37) to be available before downloading of CSS will start to prevent render blocking issues in IE11. This requires a costly `setTimeout` solution.

`asyncCSS` does not favor IE over modern browsers and starts downloads immediately, saving costly milliseconds and reducing javascript burden.

## Google Closure Compiler module concatenation

`asyncCSS` is optimized for performance in the finest detail. The script is compiled into individual modules via [Google Closure Compiler](https://developers.google.com/closure/compiler/) that does not just compress javascript but also [optimizes it for speed](https://developers.google.com/closure/compiler/). This ensures optimal reliability and performance on all devices. 

The module loading innovation enables to concatenate individual modules together in a `<script>` element in the document header, without a module loader.

##### Example:

```html
<script src="dist/async-core.js"></script> <!-- core async functionality -->
<script src="dist/css-loader.js"></script> <!-- async css loader -->
<script src="dist/cache.js"></script> <!-- cache module -->
<script src="dist/localstorage.js"></script> <!-- localStorage cache module -->
```

You could use your CMS (PHP, Node.js etc.) to inline the scripts. You can simply concatenate the scripts.

Wiki: [CMS integration: Google Closure Compiler module concatenation](https://github.com/style-tools/async-css/wiki/CMS-integration:-Google-Closure-Compiler-module-concatenation)

## IIFE pre-concatenated scripts

For easy usage it is possible to create an IIFE (a pre-concatenated CSS loader script). 

##### Example:

```html
<script async src="dist/iife.js"></script>
```

An advantage of IIFE is that it adds a Google Closure Compiler optimization layer over the concatenated modules which improves the compression.

This repository provides [iife.js](https://github.com/style-tools/async-css/blob/master/iife.js), a simple Node.js program that can be executed from the command line or using Node.js to generate an IIFE or concatenated script with a selection of modules. The [php-cms-connector](https://github.com/style-tools/php-cms-connector/) Composer library for PHP provides a method for generating an IIFE as well.

Wiki: [Build IIFE CSS loader with a selection of modules](https://github.com/style-tools/async-css/wiki/Build-IIFE-CSS-loader-with-a-selection-of-modules)

## Chainable and events

The CSS loader is easy to use and provides onload events. The `asyncCSS` load method returns a `then` method that resolves like a Promise when all stylesheets are rendered.

```javascript
// simple async loading
asyncCSS('sheet.css').then(function() { /* onload */ });

// dependencies, timing and global options
asyncCSS(
   [ // load 2 sheets
      'sheet.css', 
      { href:'other-sheet.js', dependencies: ['sheet.css'] } // wait for sheet.css via dependencies
   ],
   { // optional: options applied to all stylesheets
      cache: {
         type: "localStorage",
         max_size: 10000 // cache only <10kb
      },
      load_timing: {
         type: 'inview',
         selector: '#footer' // download stylesheet when footer becomes visible within 250 pixels
         offset: -250
      },
      render_timing: 'requestAnimationFrame' // render via requestAnimationFrame
   } 
).then(function() { /* ready */ });

// chainable
asyncCSS
   .capture([{match:"bloated-sheet.css","action": {"type":"remove"}}], {insert:true}) // capture and remove bloated-sheet.css
   .load({href: 'sheet.css', ref: 'sheet-ref'}) // alternative via .load
   .then(function() { }) // all sheets loaded
   .on('load',function(sheet, sheetEl){ }) // individual sheet loaded
   .on('sheet-ref',function() { }) // sheet with ref-name loaded
   .on('sheet.css', function() {}); // sheet with href loaded
```

### JSON schema config

The configuration of the CSS loader is available in a JSON schema.

https://github.com/style-tools/async-css/tree/master/json-schemas

### Config compression innovation

To further reduce the size in the header, the CSS loader can be configured using the HTML attribute `data-c` on the script element that contains the configuration to pass to `asyncCSS` as soon as the script is loaded.

**Note:** This feature requires the `attr-config` module. When not using the attribute loading mechanism, the code for the feature can be saved from the script.

The configuration can be compressed into a numeric index based JSON object to achieve the smallest size possible for complex JSON based configuration.

#### Example

Non-compressed.

```html
<script async src="dist/iife/all.js"></script>
<script async>asyncCSS("css/style.css", {"href": "css/extra.css", "load_timing": "domReady"})</script>
```

Compressed + using attribute config.

```html
<script async src="dist/iife/all.js" data-c='["css/style.css",{"4":"css/extra.css","21":27}]'></script>
```

### CSS Loading Optimization

Modern website performance optimization requires the optimization of CSS loading. It is essential for performance scores such as the [Google Lighthouse](https://developers.google.com/web/tools/lighthouse/) score, an increasingly important aspect for modern SEO (search engine optimization).

> Before the browser can render content it must process all the style and layout information for the current page. As a result, the browser will block rendering until external stylesheets are downloaded and processed, which may require multiple roundtrips and delay the time to first render.
>
> The critical styles needed to style the above-the-fold content are inlined and applied to the document immediately. The larger stylesheets are loaded asynchronously and are applied to the document once it finishes loading, or using an optional conditional timing method, without blocking the initial render of the critical content.
> 
> [Google PageSpeed Insights](https://developers.google.com/speed/docs/insights/OptimizeCSSDelivery)
